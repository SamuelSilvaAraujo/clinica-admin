{% extends 'base.html' %}

{% load static %}

{% block head %}


    <link href="{% static 'libs/fullCalendar/core/main.css' %}" rel='stylesheet' />
    <link href="{% static 'libs/fullCalendar/bootstrap/main.css' %}" rel='stylesheet' />
    <link href="{% static 'libs/fullCalendar/daygrid/main.css' %}" rel='stylesheet' />
    <link href="{% static 'libs/fullCalendar/timegrid/main.css' %}" rel='stylesheet' />
    <link href="{% static 'libs/fullCalendar/timeline/main.css' %}" rel='stylesheet' />
    <link href="{% static 'libs/fullCalendar/resource-timeline/main.css' %}" rel='stylesheet' />


{% endblock %}

{% block header %}
    <h2>
        Agenda
    </h2>
{% endblock %}

{% block content %}

    <div class="row">
        <div class="col-lg-12">
            <div id="calendar"></div>
        </div>
    </div>

{% endblock %}

{% block script %}


    <script src="{% static 'libs/fullCalendar/core/main.js' %}"></script>
    <script src="{% static 'libs/fullCalendar/bootstrap/main.js' %}"></script>
    <script src="{% static 'libs/fullCalendar/interaction/main.js' %}"></script>
    <script src="{% static 'libs/fullCalendar/daygrid/main.js' %}"></script>
    <script src="{% static 'libs/fullCalendar/timegrid/main.js' %}"></script>
    <script src="{% static 'libs/fullCalendar/timeline/main.js' %}"></script>
    <script src="{% static 'libs/fullCalendar/resource-common/main.js' %}"></script>
    <script src="{% static 'libs/fullCalendar/resource-timeline/main.js' %}"></script>
    <script src="{% static 'libs/fullCalendar/core/locales/pt-br.js' %}"></script>

    <script src="{% static 'libs/bootbox/bootbox.min.js' %}"></script>
    <script src="{% static 'libs/bootbox/bootbox.locales.min.js' %}"></script>


    <script>
        $(document).ready(function() {
            var calendarEl = document.getElementById('calendar');

            var calendar = new FullCalendar.Calendar(calendarEl, {
                plugins: [ 'bootstrap', 'interaction', 'dayGrid', 'timeGrid', 'resourceTimeline' ],
                locale: 'pt-br',
                themeSystem: 'bootstrap',
                allDaySlot: false,
                editable: true,
                selectable: true,
                slotDuration: '00:30',
                displayEventTime: true,
                slotLabelFormat: {
                    hour: '2-digit',
                    minute: '2-digit',
                    timeformat: 'H:mm',
                },
                header: {
                    left: 'today prev,next',
                    center: 'title',
                    right: 'timeGridDay,resourceTimelineThreeDays,timeGridWeek,dayGridMonth'
                },
                defaultView: 'timeGridDay',
                views: {
                    resourceTimelineThreeDays: {
                        type: 'timeGridWeek',
                        duration: { days: 3 },
                        buttonText: '3 dias'
                    }
                },
                events:"{% url 'appointments_ajax' %}",
                select: function(info) {
                    var start = `${info.start.getDate()}-${info.start.getMonth() + 1}-${info.start.getFullYear()} ${info.start.getHours()}:${info.start.getMinutes()}`;
                    var end = `${info.end.getDay()}-${info.end.getMonth()}-${info.end.getFullYear()} ${info.end.getHours()}:${info.end.getMinutes()}`;
                    window.location.href = `{% url 'appointment_create' %}?start=${start}&end=${end}`;
                },
                eventClick: function (info) {

                    var buttons = {
                        danger: {
                            label: 'Editar',
                            className: 'btn-success',
                            callback: function () {
                                window.location.href = `/agenda/update/agendamento/${info.event.id}/`;
                            },
                        }
                    };

                    var appointment_status = info.event.extendedProps.status,
                        status_msg = '';

                    if (appointment_status === 'scheduled') {
                        status_msg = '<span badge badge-primary>Agendado</span> <br/>';
                        status_msg += `<b>Mudar Status para:</b> <button class="btn btn-sm btn-success">Atendido</button>`;
                        status_msg += `&nbsp <button class="btn btn-sm btn-danger">Cancelado</button>`;
                        status_msg += `&nbsp <button class="btn btn-sm btn-warning">Não Compareceu</button>`;
                    } else if (appointment_status === 'cancelled') {
                        status_msg = '<span>Cancelado</span>';
                    } else if (appointment_status === 'answered') {
                        status_msg = '<span>Atendido</span>';
                    }

                    bootbox.dialog({
                        title: 'Agendamento para ' + info.event.extendedProps.patient__name,
                        message: '<b>Data: </b>' + info.event.start.toLocaleDateString() + '<br/>' +
                            '<b>Observações: </b>' + info.event.extendedProps.notes + '<br/>' +
                            '<b>Status: </b>' + status_msg + '<br/>',
                        className: 'bootbox-lg',
                        onEscape: true,
                        buttons: buttons
                    });
                }

            });
            calendar.render();
        });

    </script>

{% endblock %}